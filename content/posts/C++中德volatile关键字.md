Title: c++中的volatile关键字
Date: 2015-3-31 13:05:48
Category: C/C++
Tags: C/C++, volatile
Slug: C_plus_plus_volatile

&nbsp;volatile和const关键字一样，是一个类型修饰符，表示变量可以被编译器的某些未知因素修改，比如操作系统，硬件，某些线程等。遇到这个关键字声明的变量，编译器访问该变量的代码将不再进行优化，以提供特殊地址的稳定访问。


 使用该关键字的例子如下： 
```
int volatile nVint;//当要求使用volatile声明的变量的值的时候，系统总是重新从它所在的内存读取数据，即使它前面的指令刚刚从该处读取过数据。而且读取的数据立刻被保存。
```

对于这样的代码：
```
volatile int i = 10; 
int a = i;
... //其他代码，并未明确告诉编译器，对i进行过操作
int b = i;
```
volatile 指出 i是随时可能发生变化的，每次使用它的时候必须从i的地址中读取，因而编译器生成的汇编代码会重新从i的地址读取数据放在b中。而优化做法是，由于编译器发现两次从i读数据的代码之间的代码没有对i进行过操作，它会自动把上次读的数据放在b中。而不是重新从i里面读。这样以来，如果i是一个寄存器变量或者表示一个端口数据就容易出错，所以说volatile可以保证对特殊地址的稳定访问。

### 多线程下的volatile  

&nbsp;&nbsp;有些变量是用volatile关键字声明的。当两个线程都要用到某一个变量且该变量的值会被改变时，应该用volatile声明，该关键字的作用是防止优化编译器把变量从内存装入CPU寄存器中。如果变量被装入寄存器，那么两个线程有可能一个使用内存中的变量，一个使用寄存器中的变量，这会造成程序的错误执行。volatile的意思是让编译器每次操作该变量时一定要从内存中真正取出，而不是使用已经存在寄存器中的值。


### 一般说来，volatile用在如下的几个地方
1. 中断服务程序中修改的供其它程序检测的变量需要加volatile；
2. 多任务环境下各任务间共享的标志应该加volatile；
3. 存储器映射的硬件寄存器通常也要加volatile说明，因为每次对它的读写都可能由不同意义。

另外，以上这几种情况经常还要同时考虑数据的完整性（相互关联的几个标志读了一半被打断了重写），在1中可以通过关中断来实现，2中可以禁止任务调度，3中则只能依靠硬件的良好设计了。


### 参考文章：
* [C/C++ Volatile关键词深度剖析 --何登成](http://hedengcheng.com/?p=725)